# MinIO Public URL Fix

## Problem

Presigned URLs generated by MinIO were using internal Docker network hostname (`minio:9000`), causing signature mismatch when accessed from host browser (`localhost:9000`). This resulted in **HTTP 403 Forbidden** errors.

## Root Cause

- MinIO Python client connects to `http://minio:9000` (internal Docker network)
- Presigned URLs are signed with the hostname used in the connection
- When URL hostname is replaced (`minio:9000` → `localhost:9000`), the signature becomes invalid
- MinIO rejects requests with invalid signatures (403 Forbidden)

## Solution

Instead of using presigned URLs (which require signature validation), we:

1. **Set MinIO bucket to public read** for `uploads/` and `outputs/` folders:

   ```bash
   mc anonymous set download local/smartfashion/uploads
   mc anonymous set download local/smartfashion/outputs
   ```

2. **Use direct public URLs** without signatures:
   - Added `get_public_url()` method to `MinIOService`
   - Returns direct URL: `http://localhost:9000/smartfashion/{object_key}`
   - No signature required, works with public bucket policy

## Changes Made

### 1. `app/services/minio_service.py`

Added new method:

```python
def get_public_url(self, object_name: str, bucket_name: Optional[str] = None) -> str:
    """Get a direct public URL for accessing an object."""
    bucket = bucket_name or self.default_bucket
    return f"{MINIO_EXTERNAL_ENDPOINT}/{bucket}/{object_name}"
```

### 2. `app/controllers/gallery_controller.py`

Replaced `get_presigned_url()` with `get_public_url()`:

- Line 64, 67: Gallery page rendering
- Line 111, 115: API gallery endpoint

### 3. `app/services/api.py`

Replaced `get_presigned_url()` with `get_public_url()`:

- Line 228-229: Segment endpoint output URLs

### 4. MinIO Bucket Policy

Set public download permission:

```bash
podman exec minio sh -c "mc alias set local http://localhost:9000 admin admin123456 && \
  mc anonymous set download local/smartfashion/uploads && \
  mc anonymous set download local/smartfashion/outputs"
```

## Verification

### Test Results

- ✅ `test_segment_presigned_url_accessible` - **PASSED** (was xfail)
- ✅ `test_gallery_urls_use_localhost` - **PASSED**
- ✅ Manual URL test: HTTP 200 OK

### Quick Verification Script

```bash
poetry run python verify_image_urls.py
```

Output:

```
✓ Gallery API returned 50 images
✓ Testing URL: http://localhost:9000/smartfashion/outputs/...
✓ Image URL is accessible (HTTP 200)
✓ Content-Type: image/jpeg
✓ Content-Length: 111709 bytes
✅ All image URL tests passed!
```

## Security Considerations

**Public Bucket Policy:**

- Only `uploads/` and `outputs/` folders are public
- Model files and other data remain private
- Suitable for development and demo environments

**For Production:**

- Consider using presigned URLs with proper endpoint configuration
- Or implement authentication/authorization layer
- Or use CDN with access control

## Migration Notes

If you need to revert to presigned URLs:

1. Remove bucket policy: `mc anonymous set none local/smartfashion/uploads`
2. Replace `get_public_url()` calls back to `get_presigned_url()`
3. Ensure MinIO client connects using external endpoint
